<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Continental Stream Morphology Research empowered by open data â€¢ climateR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Continental Stream Morphology Research empowered by open data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">climateR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.7</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mikejohnson51/climateR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Continental Stream Morphology Research empowered by open data</h1>
                        <h4 data-toc-skip class="author">Arash Modaresi
Rad</h4>
            <address class="author_afil">
      Lynker<br><h4 data-toc-skip class="author">Mike
Johnson</h4>
            <address class="author_afil">
      Lynker<br><small class="dont-index">Source: <a href="https://github.com/mikejohnson51/climateR/blob/HEAD/vignettes/stream-morph.Rmd" class="external-link"><code>vignettes/stream-morph.Rmd</code></a></small>
      <div class="d-none name"><code>stream-morph.Rmd</code></div>
    </address>
</address>
</div>

    
    
<div class="section level2">
<h2 id="examples">Examples<a class="anchor" aria-label="anchor" href="#examples"></a>
</h2>
<p>We all can agree that access to tools to perform spatial operations
has revolutionized the field of hydrologic sciences by offering a
powerful platforms to access satellite imagery, reanalysis products, and
diverse datasets crucial for spatial analysis and hydrologic modeling.
These tools facilitate the retrieval and processing of vast amounts of
geospatial data, allowing researchers and practitioners to perform
comprehensive analyses at various spatial and temporal scales, which in
turn greatly benefits the field of hydrology.</p>
<p>Our team at Lynker have developed <a href="https://github.com/mikejohnson51/climateR.git" class="external-link">climateR</a> and <a href="https://github.com/LynkerIntel/climatePy" class="external-link">climatePy</a>.The key
advantages of using platforms like climateR is the accessibility to a
wealth of satellite imagery spanning multiple decades. With archives of
satellite data readily available, hydrologists can track changes in land
cover, monitor hydrologic phenomena, and assess the impacts of climate
change on water resources. The ability to access and analyze historical
data allows for the identification of long-term trends, facilitating
better understanding and prediction of hydrologic processes.</p>
<p>Furthermore, climateR foster collaboration and knowledge sharing
within the hydrologic community. It provide a platform for scientists
and researchers across the globe to access standardized datasets, share
methodologies, and collaborate on solving complex hydrologic challenges.
Also, puts forth an easy and accessible way to perform large
spatiotemporal operations that support any NOAA effort. This
collaborative environment encourages the development of innovative
models and techniques for water resource management and
decision-making.</p>
<p>Here we demonstrate several examples of how to access these databases
using climateR and perform massive spatial and temporal
aggregations.</p>
<div class="section level3">
<h3 id="massive-spatial-aggregation-of-terraclimate">Massive Spatial Aggregation of TerraClimate<a class="anchor" aria-label="anchor" href="#massive-spatial-aggregation-of-terraclimate"></a>
</h3>
<p>The integration of reanalysis products and various datasets in this
platform enables users to perform sophisticated spatial operations and
analyses. Hydrologists can aggregate data over specific points or
polygons, allowing for the extraction of critical information regarding
water resources, such as precipitation patterns, evapotranspiration
rates, and soil moisture content. This facilitates the characterization
of watersheds, the assessment of water availability, and the prediction
of potential flood or drought events.</p>
<p>Here I want to extract long term, 20 year historical mean value of
TerraClimate variables for all NOAA Next Generation (NextGen) National
Hydrologic Geospatial Fabric (hydrofabric) divides. As you no doubt
surmised, this is a very expensive task but with climateR it will become
a more straight forward task.</p>
<p>One can access the NextGen hydrofabric from the Lynker-spatial s3
account:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Then specify the S3 bucket and file path</span></span>
<span><span class="va">bucket_name</span> <span class="op">&lt;-</span> <span class="st">"lynker-spatial"</span></span>
<span><span class="va">file_key</span>    <span class="op">&lt;-</span> <span class="st">"v20/gpkg/nextgen_12.gpkg"</span></span>
<span></span>
<span><span class="co"># Now download the GeoPackage file from S3 to a temporary file</span></span>
<span><span class="va">temp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".gpkg"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">s3read_using</span><span class="op">(</span>file   <span class="op">=</span> <span class="va">temp_file</span>, </span>
<span>             FUN    <span class="op">=</span> <span class="va">get_object</span>, </span>
<span>             object <span class="op">=</span> <span class="va">file_key</span>, </span>
<span>             bucket <span class="op">=</span> <span class="va">bucket_name</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Finally read the GeoPackage file into an sf object</span></span>
<span><span class="va">gpkg_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="va">temp_file</span><span class="op">)</span></span></code></pre></div>
<p>Now we can extract the divides layer for the given VPU and extract
data from TerraClimate:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># List of VPU's for CONUS</span></span>
<span><span class="va">vpu_list</span> <span class="op">=</span> <span class="va">vpu_boundaries</span><span class="op">$</span><span class="va">VPUID</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">21</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Variables of Interest</span></span>
<span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PDSI"</span>,<span class="st">"aet"</span>,<span class="st">"soil"</span>,<span class="st">"def"</span>,<span class="st">"ppt"</span>,<span class="st">"q"</span>,<span class="st">"tmin"</span>,<span class="st">"tmax"</span>,<span class="st">"pet"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop through the VPU's and extract data and time the execution </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">vpu</span> <span class="kw">in</span> <span class="va">vpu_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># Read the file</span></span>
<span>        <span class="va">file_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"v20/gpkg/nextgen_"</span>, <span class="va">vpu</span>, <span class="st">".gpkg"</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Download the GeoPackage file from S3 to a temporary file</span></span>
<span>        <span class="va">temp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".gpkg"</span><span class="op">)</span></span>
<span>        <span class="fu">s3read_using</span><span class="op">(</span>file <span class="op">=</span> <span class="va">temp_file</span>, </span>
<span>                     FUN <span class="op">=</span> <span class="va">get_object</span>, </span>
<span>                     object <span class="op">=</span> <span class="va">file_key</span>, </span>
<span>                     bucket <span class="op">=</span> <span class="va">bucket_name</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Just read the divides</span></span>
<span>        <span class="va">divides</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">temp_file</span>, <span class="st">"divides"</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Use climateR to extract the variables between 2000-2021</span></span>
<span>        <span class="va">out_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getTerraClim.html">getTerraClim</a></span><span class="op">(</span>AOI       <span class="op">=</span> <span class="va">divides</span>,</span>
<span>                                   varname   <span class="op">=</span>  <span class="va">vars</span>,</span>
<span>                                   startDate <span class="op">=</span> <span class="st">"2000-01-01"</span>,</span>
<span>                                   endDate   <span class="op">=</span> <span class="st">"2021-01-01"</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Use rast() to do a temporal mean aggregation and zonal to do a spatial aggregation using divide_id</span></span>
<span>        <span class="va">output</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zonal/man/execute_zonal.html" class="external-link">execute_zonal</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">out_raster</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                               geom <span class="op">=</span> <span class="va">div</span>, </span>
<span>                               fun <span class="op">=</span> <span class="st">"mean"</span>, </span>
<span>                               ID <span class="op">=</span> <span class="st">"divide_id"</span>, </span>
<span>                               join <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Finally write the data frame to a parquet file</span></span>
<span>        <span class="fu">write_parquet</span><span class="op">(</span><span class="va">output</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"/your_path/conus_terraclimate_vpu_%s.parquet"</span>, <span class="va">vpu</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We just calculated 20 year average of 9 different variables over
882,945 divides that cover CONUS under an hour (2472.777 seconds = .68
hours) on my normal laptop!! This is very impressive. Here is the result
of the 20 year average Palmer drought severity index:</p>
<p><img src="../reference/figures/data_PDSI.jpg" width="100%"></p>
</div>
<div class="section level3">
<h3 id="comparison-to-gee">Comparison to GEE<a class="anchor" aria-label="anchor" href="#comparison-to-gee"></a>
</h3>
<p>Now lets compare this to the well known and frequently used Google
Earth Engine (GEE).</p>
<p>To start, we cannot process all 882,945 divides at the same time in
GEE and my personal experience has shown that batches of 200 divides is
the ideal size to avoid the infamous
<code>Computation Timed Out Error</code>.</p>
<p>So we can write a script to perform batch operation such as
below.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co">// This requires uploading the divides into EE assets</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co">// A for loop to execute 100 batches of 200 divides as an example</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;</span><span class="dv">100</span><span class="op">;</span> i<span class="op">++</span>){</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    <span class="fu">runExtract</span>(divides<span class="op">,</span> i<span class="op">,</span> <span class="st">'last'</span>)<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>}</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="fu">runExtract</span>(divides<span class="op">,</span> <span class="dv">100</span><span class="op">,</span> <span class="st">'first'</span>)<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="kw">function</span> <span class="fu">runExtract</span>(data<span class="op">,</span> num<span class="op">,</span> first){</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>    <span class="kw">var</span> list_feature <span class="op">=</span> data<span class="op">.</span><span class="fu">toList</span>(data<span class="op">.</span><span class="fu">size</span>())<span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>    <span class="kw">var</span> batch <span class="op">=</span> num<span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>    </span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>    <span class="cf">switch</span>(first){</span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">'first'</span><span class="op">:</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>        <span class="kw">var</span> data <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(list_feature<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">2000</span><span class="op">-</span>(batch<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span><span class="dv">200</span>))<span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">'last'</span><span class="op">:</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>        <span class="kw">var</span> data <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(list_feature<span class="op">.</span><span class="fu">slice</span>(<span class="dv">2000</span><span class="op">-</span>batch<span class="op">*</span><span class="dv">200</span><span class="op">,</span> <span class="dv">2000</span><span class="op">-</span>(batch<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span><span class="dv">200</span>))<span class="op">;</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">'custom'</span><span class="op">:</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>        <span class="kw">var</span> data <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(list_feature)<span class="op">;</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>    }</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>    batch <span class="op">=</span> batch<span class="op">.</span><span class="fu">toString</span>()<span class="op">;</span></span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a>    <span class="co">// Load TerraClimate</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>    <span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'IDAHO_EPSCOR/TERRACLIMATE'</span>)</span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">'2000-01-01'</span><span class="op">,</span> <span class="st">'2022-01-01'</span>))<span class="op">;</span></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>    <span class="co">// Performs a temporal mean </span></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>    <span class="kw">var</span> aet <span class="op">=</span> dataset<span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">select</span>(<span class="st">'aet'</span>)<span class="op">;</span>   </span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>    <span class="kw">var</span> soil <span class="op">=</span> dataset<span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">select</span>(<span class="st">'soil'</span>)<span class="op">;</span>   </span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>    <span class="kw">var</span> pet <span class="op">=</span> dataset<span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">select</span>(<span class="st">'pet'</span>)<span class="op">;</span>   </span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>    <span class="kw">var</span> def <span class="op">=</span> dataset<span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">select</span>(<span class="st">'def'</span>)<span class="op">;</span>   </span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a>    <span class="kw">var</span> pdsi <span class="op">=</span> dataset<span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">select</span>(<span class="st">'pdsi'</span>)<span class="op">;</span>   </span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a>    <span class="kw">var</span> ro <span class="op">=</span> dataset<span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">select</span>(<span class="st">'ro'</span>)<span class="op">;</span>  </span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a>    <span class="kw">var</span> tmmn <span class="op">=</span> dataset<span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">select</span>(<span class="st">'tmmn'</span>)<span class="op">;</span> </span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a>    <span class="kw">var</span> tmmx <span class="op">=</span> dataset<span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">select</span>(<span class="st">'tmmx'</span>)<span class="op">;</span> </span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a>    <span class="co">// _______Extract data_________________</span></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">updateDivides</span>(img_dataset<span class="op">,</span> old_dataset<span class="op">,</span> bandname<span class="op">,</span> newname<span class="op">,</span> reducer)</span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a>    {</span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a>        <span class="kw">function</span> <span class="fu">dataExtract</span>(feat)</span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a>        {</span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a>            </span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a>        <span class="kw">var</span> stats <span class="op">=</span> img_dataset<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a>            <span class="dt">reducer</span><span class="op">:</span> reducer<span class="op">,</span></span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a>            <span class="dt">geometry</span><span class="op">:</span> feat<span class="op">.</span><span class="fu">geometry</span>()<span class="op">,</span></span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a>            <span class="dt">scale</span><span class="op">:</span> <span class="fl">4638.3</span><span class="op">,</span>  </span>
<span id="cb3-49"><a href="#cb3-49" tabindex="-1"></a>            <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb3-50"><a href="#cb3-50" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb3-51"><a href="#cb3-51" tabindex="-1"></a>        </span>
<span id="cb3-52"><a href="#cb3-52" tabindex="-1"></a>        <span class="cf">return</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(ee<span class="op">.</span><span class="fu">Number</span>(stats<span class="op">.</span><span class="fu">size</span>())<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">,</span> </span>
<span id="cb3-53"><a href="#cb3-53" tabindex="-1"></a>                                    feat<span class="op">.</span><span class="fu">set</span>(newname<span class="op">,</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">999999999</span>))<span class="op">,</span></span>
<span id="cb3-54"><a href="#cb3-54" tabindex="-1"></a>                                    feat<span class="op">.</span><span class="fu">set</span>(newname<span class="op">,</span> stats<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">get</span>(bandname)))<span class="op">;</span></span>
<span id="cb3-55"><a href="#cb3-55" tabindex="-1"></a>        </span>
<span id="cb3-56"><a href="#cb3-56" tabindex="-1"></a>        }</span>
<span id="cb3-57"><a href="#cb3-57" tabindex="-1"></a>        <span class="kw">var</span> new_dataset <span class="op">=</span> old_dataset<span class="op">.</span><span class="fu">map</span>(dataExtract)<span class="op">;</span></span>
<span id="cb3-58"><a href="#cb3-58" tabindex="-1"></a>        <span class="cf">return</span> new_dataset<span class="op">;</span></span>
<span id="cb3-59"><a href="#cb3-59" tabindex="-1"></a>    }</span>
<span id="cb3-60"><a href="#cb3-60" tabindex="-1"></a></span>
<span id="cb3-61"><a href="#cb3-61" tabindex="-1"></a>    data <span class="op">=</span> <span class="fu">updateStation</span>(aet<span class="op">,</span> data<span class="op">,</span><span class="st">'aet'</span><span class="op">,</span> <span class="st">'aet'</span><span class="op">,</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>())<span class="op">;</span></span>
<span id="cb3-62"><a href="#cb3-62" tabindex="-1"></a>    data <span class="op">=</span> <span class="fu">updateStation</span>(soil<span class="op">,</span> data<span class="op">,</span><span class="st">'soil'</span><span class="op">,</span> <span class="st">'soil'</span><span class="op">,</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>())<span class="op">;</span></span>
<span id="cb3-63"><a href="#cb3-63" tabindex="-1"></a>    data <span class="op">=</span> <span class="fu">updateStation</span>(pet<span class="op">,</span> data<span class="op">,</span><span class="st">'pet'</span><span class="op">,</span> <span class="st">'pet'</span><span class="op">,</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>())<span class="op">;</span></span>
<span id="cb3-64"><a href="#cb3-64" tabindex="-1"></a>    data <span class="op">=</span> <span class="fu">updateStation</span>(def<span class="op">,</span> data<span class="op">,</span><span class="st">'def'</span><span class="op">,</span> <span class="st">'def'</span><span class="op">,</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>())<span class="op">;</span></span>
<span id="cb3-65"><a href="#cb3-65" tabindex="-1"></a>    data <span class="op">=</span> <span class="fu">updateStation</span>(pdsi<span class="op">,</span> data<span class="op">,</span><span class="st">'pdsi'</span><span class="op">,</span> <span class="st">'pdsi'</span><span class="op">,</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>())<span class="op">;</span></span>
<span id="cb3-66"><a href="#cb3-66" tabindex="-1"></a>    data <span class="op">=</span> <span class="fu">updateStation</span>(ro<span class="op">,</span> data<span class="op">,</span><span class="st">'ro'</span><span class="op">,</span> <span class="st">'ro'</span><span class="op">,</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>())<span class="op">;</span></span>
<span id="cb3-67"><a href="#cb3-67" tabindex="-1"></a>    data <span class="op">=</span> <span class="fu">updateStation</span>(tmmn<span class="op">,</span> data<span class="op">,</span><span class="st">'tmmn'</span><span class="op">,</span> <span class="st">'tmmn'</span><span class="op">,</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>())<span class="op">;</span></span>
<span id="cb3-68"><a href="#cb3-68" tabindex="-1"></a>    data <span class="op">=</span> <span class="fu">updateStation</span>(tmmx<span class="op">,</span> data<span class="op">,</span><span class="st">'tmmx'</span><span class="op">,</span> <span class="st">'tmmx'</span><span class="op">,</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>())<span class="op">;</span></span>
<span id="cb3-69"><a href="#cb3-69" tabindex="-1"></a></span>
<span id="cb3-70"><a href="#cb3-70" tabindex="-1"></a>    <span class="kw">var</span> exp_name <span class="op">=</span> <span class="st">'TerraClimate_divide_b'</span><span class="op">+</span>batch<span class="op">;</span></span>
<span id="cb3-71"><a href="#cb3-71" tabindex="-1"></a>  </span>
<span id="cb3-72"><a href="#cb3-72" tabindex="-1"></a>    Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>(data<span class="op">,</span> exp_name<span class="op">,</span> <span class="st">'TerraClimate_exports'</span><span class="op">,</span> exp_name<span class="op">,</span> <span class="st">'CSV'</span>)<span class="op">;</span></span>
<span id="cb3-73"><a href="#cb3-73" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Breaking this into batches 200 each set of two batchs takes
about 1-3 hours to complete (see figure below). Based on this, for the
scale of our application, GEE would require weeks to finish!!
</strong></p>
<p><img src="../reference/figures/ee_task.jpg" width="100%"></p>
</div>
<div class="section level3">
<h3 id="massive-temporal-and-spatial-aggregation-with-gldas">Massive Temporal and Spatial Aggregation with GLDAS<a class="anchor" aria-label="anchor" href="#massive-temporal-and-spatial-aggregation-with-gldas"></a>
</h3>
<p>Now lets say we have even more computationally demanding task as we
try to find a historical mean over a daily product from GLDAS. In this
case we can break our period into chunks (e.g., 4 years) and extract
data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define start and end dates</span></span>
<span><span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu">ymd</span><span class="op">(</span><span class="st">"2004-01-01"</span><span class="op">)</span></span>
<span><span class="va">end_date</span> <span class="op">&lt;-</span> <span class="fu">ymd</span><span class="op">(</span><span class="st">"2021-01-01"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a sequence of dates with a step of 4 years</span></span>
<span><span class="va">date_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span>, by <span class="op">=</span> <span class="st">"4 years"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># New names for the columns</span></span>
<span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"qsb_tavg"</span>, <span class="st">"qs_tavg"</span>, <span class="st">"gws_tavg"</span>, <span class="st">"esoil_tavg"</span>, <span class="st">"ecanop_tavg"</span>, <span class="st">"canopint_tavg"</span>, <span class="st">"avgsurft_tavg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop through the VPU's and extract data and time the execution </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">vpu</span> <span class="kw">in</span> <span class="va">vpu_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># Read the file</span></span>
<span>        <span class="va">file_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"v20/gpkg/nextgen_"</span>, <span class="va">vpu</span>, <span class="st">".gpkg"</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Download the GeoPackage file from S3 to a temporary file</span></span>
<span>        <span class="va">temp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".gpkg"</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="fu">s3read_using</span><span class="op">(</span>file <span class="op">=</span> <span class="va">temp_file</span>, </span>
<span>                     FUN <span class="op">=</span> <span class="va">get_object</span>,</span>
<span>                     object <span class="op">=</span> <span class="va">file_key</span>, </span>
<span>                     bucket <span class="op">=</span> <span class="va">bucket_name</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Just read the divides</span></span>
<span>        <span class="va">divides</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">temp_file</span>, <span class="st">"divides"</span><span class="op">)</span></span>
<span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">date_seq</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">current_start</span> <span class="op">&lt;-</span> <span class="va">date_seq</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>            <span class="va">current_end</span> <span class="op">&lt;-</span> <span class="va">current_start</span> <span class="op">+</span> <span class="fu">years</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span> <span class="op">-</span> <span class="fu">days</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>            <span class="va">current_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">current_start</span>, <span class="st">"%Y-%m-%d"</span><span class="op">)</span></span>
<span>            <span class="va">current_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">current_end</span>, <span class="st">"%Y-%m-%d"</span><span class="op">)</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"initiated batch &gt; "</span>, <span class="va">current_start</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>            <span class="co"># Use climateR to extract the variables between 2004-21</span></span>
<span>            <span class="va">out_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getGLDAS.html">getGLDAS</a></span><span class="op">(</span>AOI <span class="op">=</span> <span class="va">div</span>,</span>
<span>                                   varname <span class="op">=</span> <span class="va">vars</span>,</span>
<span>                                   model <span class="op">=</span> <span class="st">"CLSM025_DA1_D.2.2"</span>, </span>
<span>                                   startDate <span class="op">=</span> <span class="va">current_start</span>,</span>
<span>                                   endDate.  <span class="op">=</span> <span class="va">current_end</span><span class="op">)</span></span>
<span></span>
<span>            <span class="va">output</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zonal/man/execute_zonal.html" class="external-link">execute_zonal</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">out_raster</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span>, geom <span class="op">=</span> <span class="va">div</span>, fun <span class="op">=</span> <span class="st">"mean"</span>, ID <span class="op">=</span> <span class="st">"divide_id"</span>, join <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>            <span class="va">current_start_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu">year</span><span class="op">(</span><span class="va">current_start</span><span class="op">)</span><span class="op">)</span></span>
<span>            <span class="va">current_end_year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu">year</span><span class="op">(</span><span class="va">current_end</span><span class="op">)</span><span class="op">)</span></span>
<span>            <span class="fu">write_parquet</span><span class="op">(</span><span class="va">output</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"/your_path/conus_gldas_vpu_%s_date_%s_%s.parquet"</span>, <span class="va">vpu</span>, <span class="va">current_start_year</span>, <span class="va">current_end_year</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We can then plot the average canopy band:</p>
<p><img src="../reference/figures/data_ecanopy.jpg" width="100%"></p>
</div>
<div class="section level3">
<h3 id="custom-data">Custom Data<a class="anchor" aria-label="anchor" href="#custom-data"></a>
</h3>
<p>We can also use custom datasets form our local drive or s3 bucket to
perform different aggregations. Here as an example we can access POLARIS
soil dataset and do just a spatial average of multiple virtual rasters
over all our divide polygons.</p>
<p>This collection of POLARIS data has been resampled from its native
30m resolution to a 300m COG.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vars</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"om"</span>, <span class="st">"ph"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu">glue</span><span class="op">(</span><span class="st">'/vsis3/lynker-spatial/gridded-resources/polaris300/{vars}_mean_0_5.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">vpu</span> <span class="kw">in</span> <span class="va">vpu_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># Read the file</span></span>
<span>        <span class="va">file_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"v20/gpkg/nextgen_"</span>, <span class="va">vpu</span>, <span class="st">".gpkg"</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Download the GeoPackage file from S3 to a temporary file</span></span>
<span>        <span class="va">temp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".gpkg"</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="fu">s3read_using</span><span class="op">(</span>file <span class="op">=</span> <span class="va">temp_file</span>, </span>
<span>                     FUN <span class="op">=</span> <span class="va">get_object</span>, object <span class="op">=</span> <span class="va">file_key</span>, </span>
<span>                     bucket <span class="op">=</span> <span class="va">bucket_name</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Just read the divides</span></span>
<span>        <span class="va">divides</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">temp_file</span>, <span class="st">"divides"</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">polaris</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zonal/man/execute_zonal.html" class="external-link">execute_zonal</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, </span>
<span>                                geom <span class="op">=</span> <span class="va">divides</span>, fun <span class="op">=</span> <span class="st">"mean"</span>, </span>
<span>                                ID <span class="op">=</span> <span class="st">"divide_id"</span>, </span>
<span>                                join <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Finally write the data frame to a parquet file</span></span>
<span>        <span class="fu">write_parquet</span><span class="op">(</span><span class="va">output</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"/your_path/conus_polaris_vpu_%s.parquet"</span>, <span class="va">vpu</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Here is the plot of saturated hydraulic conductivity as an
example:</p>
<p><img src="../reference/figures/data_ksat.jpg" width="100%"></p>
</div>
<div class="section level3">
<h3 id="local-data">Local Data<a class="anchor" aria-label="anchor" href="#local-data"></a>
</h3>
<p>Another example is to use a local data on your device to perform
spatio-temporal aggregation. Here we use MODIS derived leaf area index
(LAI) and we do a spatio-temporal aggregation over nextgen divides at
CONUS scale.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">raster_data</span> <span class="op">&lt;-</span> <span class="fu">brick</span><span class="op">(</span><span class="st">"/local_path_here/LAI_mean_monthly_1981-2015.nc4"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate the mean across time (assuming the time dimension is the third dimension)</span></span>
<span><span class="va">mean_across_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">raster_data</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">spat_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="va">mean_across_time</span>, <span class="st">"SpatRaster"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">vpu</span> <span class="kw">in</span> <span class="va">vpu_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Read the file</span></span>
<span>    <span class="va">file_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"v20/gpkg/nextgen_"</span>, <span class="va">vpu</span>, <span class="st">".gpkg"</span><span class="op">)</span></span>
<span>        </span>
<span>    <span class="co"># Download the GeoPackage file from S3 to a temporary file</span></span>
<span>    <span class="va">temp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".gpkg"</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">s3read_using</span><span class="op">(</span>file <span class="op">=</span> <span class="va">temp_file</span>, </span>
<span>                    FUN <span class="op">=</span> <span class="va">get_object</span>, object <span class="op">=</span> <span class="va">file_key</span>, </span>
<span>                    bucket <span class="op">=</span> <span class="va">bucket_name</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Just read the divides</span></span>
<span>    <span class="va">divides</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">temp_file</span>, <span class="st">"divides"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">output</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zonal/man/execute_zonal.html" class="external-link">execute_zonal</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">spat_raster</span>, geom <span class="op">=</span> <span class="va">divides</span>, fun <span class="op">=</span> <span class="st">"mean"</span>, ID <span class="op">=</span> <span class="st">"divide_id"</span>, join <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Finally write the data frame to a parquet file</span></span>
<span>    <span class="fu">write_parquet</span><span class="op">(</span><span class="va">output</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"/your_path/conus_lai_vpu_%s.parquet"</span>, <span class="va">vpu</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can then plot the average LAI:</p>
<p><img src="../reference/figures/data_LAI.jpg" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>In summary, using climateR significantly benefits hydrological
sciences by providing unprecedented access to diverse datasets. These
tools empower researchers, policymakers, and water resource managers to
conduct in-depth spatial analyses, ultimately enhancing our
understanding of hydrological processes and improving water resource
management strategies for a more sustainable future.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mike Johnson, Justin Singh.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
